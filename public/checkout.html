<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Checkout</title>
	<link rel="stylesheet" href="style.css">
	<!-- Stripe.js -->
	<script src="https://js.stripe.com/v3/"></script>
</head>
<body class="allergens-page app-body">
	<header>
		<h1 class="main-heading no-underline">Inspired by Naples, perfected at None Go Bye.</h1>
		<nav class="main-nav">
			   <a href="index.html">Home</a>
			   <a href="menu.html">Menu</a>
			   <a href="checkout.html">Checkout</a>
			   <a href="allergens.html">Allergens</a>
		</nav>
	</header>
	<main>
		<section id="checkout-cart">
			<h2>Your Selected Items</h2>
			<div id="cart-items"></div>
			<div id="order-details" class="order-details-box">
				<h3 class="no-margin-top">Order Details</h3>
				<label><input type="radio" name="orderType" value="collection" checked> Collection</label>
				<label class="ml-1em"><input type="radio" name="orderType" value="delivery"> Delivery</label><br><br>
				<input type="text" id="customer-name" placeholder="Your Name" class="input-wide mb-halfrem"><br>
				<input type="text" id="customer-phone" placeholder="Phone Number" class="input-wide mb-halfrem"><br>
				<input type="email" id="customer-email" placeholder="Email (for receipt)" class="input-wide mb-halfrem"><br>
				<textarea id="order-comments" placeholder="Comments (e.g. allergies, delivery notes)" class="input-wide mb-halfrem minheight-60"></textarea><br>
				<div id="delivery-fields">
					<input type="text" id="customer-address" placeholder="Address (for delivery)" class="input-wide mb-halfrem"><br>
					<input type="text" id="customer-postcode" placeholder="Postcode" class="input-wide mb-halfrem"><br>
				</div>
				<label for="order-time-slot" class="label-bold mt-halfrem block">Choose a time slot:</label>
				<select id="order-time-slot" class="input-wide">
					<option value="">Select a time...</option>
					<option value="17:00-17:30">17:00 - 17:30</option>
					<option value="17:30-18:00">17:30 - 18:00</option>
					<option value="18:00-18:30">18:00 - 18:30</option>
					<option value="18:30-19:00">18:30 - 19:00</option>
					<option value="19:00-19:30">19:00 - 19:30</option>
					<option value="19:30-20:00">19:30 - 20:00</option>
					<option value="20:00-20:30">20:00 - 20:30</option>
					<option value="20:30-21:00">20:30 - 21:00</option>
					<option value="21:00-21:30">21:00 - 21:30</option>
					<option value="21:30-22:00">21:30 - 22:00</option>
				</select>
			</div>
			<p id="cart-total"><strong>Total: £0.00</strong></p>
			<div style="text-align:center;margin:2em 0 1em 0;">
				<p id="cart-total-bottom"><strong>Total: £0.00</strong></p>
			</div>
			<button class="menu-item pay-card" id="pay-with-card">Pay with Card</button>
			<button class="menu-item pay-cash" id="pay-with-cash">Pay with Cash</button>
			<div id="voucher-section" class="voucher-section">
				<input type="text" id="voucher-input" placeholder="Enter voucher code" class="voucher-input">
				<button class="menu-item ml-halfrem" id="apply-voucher-btn">Apply</button>
				<div id="voucher-message" class="voucher-message"></div>
			</div>
		</section>
	</main>
	<script>
	// Load cart from localStorage and display items and total
	function loadCheckoutCart() {
		const cart = JSON.parse(localStorage.getItem('cart') || '[]');
		const cartItemsDiv = document.getElementById('cart-items');
		const cartTotalP = document.getElementById('cart-total');
		const cartTotalBottom = document.getElementById('cart-total-bottom');
		let total = 0;
		cartItemsDiv.innerHTML = '';
		cart.forEach(entry => {
			const li = document.createElement('li');
			li.textContent = `${entry.name} – £${entry.price.toFixed(2)}`;
			cartItemsDiv.appendChild(li);
			total += entry.price;
		});
		cartTotalP.innerHTML = `<strong>Total: £${total.toFixed(2)}</strong>`;
		if (cartTotalBottom) {
			cartTotalBottom.innerHTML = `<strong>Total: £${total.toFixed(2)}</strong>`;
		}
	}
	window.onload = function() {
		loadCheckoutCart();
			document.getElementById('pay-with-cash').addEventListener('click', async function() {
				const cart = JSON.parse(localStorage.getItem('cart') || '[]');
				const total = cart.reduce((sum, item) => sum + item.price, 0);
				const orderType = document.querySelector('input[name="orderType"]:checked').value;
				const customerName = document.getElementById('customer-name').value;
				const customerPhone = document.getElementById('customer-phone').value;
				const customerEmail = document.getElementById('customer-email').value;
				const orderComments = document.getElementById('order-comments').value;
				const customerAddress = document.getElementById('customer-address').value;
				const customerPostcode = document.getElementById('customer-postcode').value;
				const orderTimeSlot = document.getElementById('order-time-slot').value;
				if (!cart.length || !customerName || !customerPhone || !orderTimeSlot) {
					alert('Please fill in all required fields and add items to your cart.');
					return;
				}
					const order = {
						cart,
						total,
						orderType,
						customerName,
						customerPhone,
						customerEmail,
						orderComments,
						customerAddress,
						customerPostcode,
						orderTimeSlot,
						placedAt: new Date().toISOString()
					};
				try {
					const res = await fetch('https://pizza-site-c8t6.onrender.com/cash-order', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(order)
					});
					if (res.ok) {
						alert('Thank you! Your order has been placed for cash payment. Please pay at the counter or on delivery.');
						localStorage.removeItem('cart');
						window.location.href = 'index.html';
					} else {
						const data = await res.json();
						alert('Error placing order: ' + (data.error || 'Unknown error'));
					}
				} catch (e) {
					alert('Network error. Please try again.');
				}
			});
	};
	</script>
</body>
</html>
